# Go 1.17

Go 1.17 был выпущен 16 августа 2021 года

## Новый способ передачи аргументов в функции (Register-based calling convention)
Раньше аргументы функций на x86-64 всегда передавались через стек.
Теперь до 9 аргументов (целочисленных/указателей) передаются через регистры CPU, что ускоряет вызовы функций.
Результат: Прирост производительности ~5%.
Пока работает только на Linux/macOS (amd64), в будущих версиях — на других платформах.

## Новые API в стандартной библиотеке

* Новые функции в `unsafe`
Добавлены `unsafe.Add` и `unsafe.Slice` для более безопасной работы с указателями:

```go
ptr := unsafe.Pointer(...)
arr := unsafe.Slice((*int)(ptr), 10)  // Создает слайс из указателя
newPtr := unsafe.Add(ptr, 16)         // ptr + 16 байт
```

* `io.ReadAll` теперь использует `strings.Builder`
Стало быстрее читать данные в память.

* Новые методы в `sync.Map`
Добавлены `LoadAndDelete` и `Swap` для атомарных операций.

* `os.DirFS(name string)` — создаёт `fs.FS`, представляющую локальную файловую систему (часть `io/fs` API).

## Новый синтаксис для легкого и безопасного преобразования среза в массив

```go
s := []int{1, 2, 3}

// Преобразовать срез s в указатель на массив длиной 3
a := (*[3]int)(s)

// Преобразовать срез s в указатель на массив той же длины, что и s
b := (*[len(s)]int)(s)
```

Если длина среза не соответствует длине массива, произойдет ошибка паники (`panic`).

## Изменения в модулях Go

* `go.mod` теперь поддерживает `//indirect` с версиями

Раньше:
```go
require (
    example.com/foo v1.0.0 // indirect
)
```

Теперь можно явно указать, какая зависимость добавила `indirect`:
```go
require (
    example.com/foo v1.0.0 // indirect (from example.com/bar v2.1.0)
)
```

* Новый синтаксис `pruned` и `lazy` модулей

Улучшена работа с редко используемыми зависимостями (оптимизация размера `go.mod`).

## Улучшенный `go install` с указанием версии

Теперь можно устанавливать бинарные инструменты без необходимости использовать `go get` или модифицировать `go.mod`.

```bash
go install example.com/tool@v1.2.3
```

## Упрощённый переход между модулями в go CLI

Команды `go get`, `go install` и другие теперь ведут себя более предсказуемо.
* `go install` — для установки бинарников
* `go get` — для добавления зависимостей

## Улучшения в инструментах разработки

* `go test -shuffle`

Тесты можно запускать в случайном порядке (для выявления зависимостей между тестами):

```bash
go test -shuffle=on -v ./...
```

* `go vet` теперь проверяет `time.Format`

Находит ошибки в шаблонах времени:

```go
t.Format("2006-01-02 15:04:05")  // OK
t.Format("2023-01-02")           // Подозрительно (go vet предупредит)
```

* `go build` теперь кэширует результаты для `-cover`

Ускорение сборки с профилированием покрытия кода.

## Улучшения компилятора и линкера

* Ускорена компиляция (особенно для больших проектов).
* Уменьшен размер бинарников за счет оптимизации таблиц отладочной информации.
* Линковка на Linux/AMD64 теперь использует `gold` вместо `ld` (быстрее и меньше памяти).

## Улучшения в `testing`

* Пакет `testing` получил поддержку таймаутов по умолчанию для подтестов (subtests).
* Улучшена диагностика при панике в тестах.
* Лучшая интеграция с IDE и `go test -json`.

## Оптимизация сборщика мусора (GC)
* Улучшена производительность и снижена пауза GC при высоких нагрузках.
* Влияние на задержки уменьшилось, особенно при большом числе `goroutine`.

## Изменения в работе cgo

* Упрощена передача `char**` между Go и C.
* Новые правила для `//go:embed` в cgo-файлах.

## Прочие улучшения

* Unicode обновлен до версии 13.0.0.
* Уменьшено потребление памяти в `encoding/json`.
* Оптимизированы `fmt.Sprintf` и `strconv`.
* Улучшено поведение `defer` (меньше накладных расходов).
* Используйте `go mod -trimpath` для уменьшения размера бинарных файлов и ускорения разрешения зависимостей.

## Поддержка новых платформ

* Windows/ARM64 — нативная поддержка для устройств на ARM (например, Surface Pro X).
* macOS/ARM64 — улучшена работа на Apple Silicon (M1).
* Linux/PPC64 — теперь поддерживается POWER9.
