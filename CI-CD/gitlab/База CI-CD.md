# База CI-CD

**CI/CD (Continuous Integration / Continuous Delivery или Continuous Deployment)** — это набор практик и инструментов для автоматизации процессов разработки, тестирования и поставки программного обеспечения.



**CI (Continuous Integration — Непрерывная интеграция)** - автоматически собирает и тестирует код при каждом изменении, чтобы быстро находить ошибки. При каждом коммите запускается автоматическая сборка и тестирование (юнит-тесты, линтеры и т. д.).



**CD (Continuous Delivery / Deployment** — Непрерывная доставка или развертывание)

**Continuous Delivery** – автоматическая подготовка кода к релизу (но развертывание вручную).

**Continuous Deployment** – полная автоматизация, когда код после тестов сразу попадает в продакшен.



**CI** — это автоматизированный процесс, который собирает, тестирует и проверяет код при каждом изменении в репозитории. В GitLab он работает на основе файла `.gitlab-ci.yml`

Конфигурации `gitlab-ci.yml` состоит:

* ***stages** – определяет этапы пайплайна (тест → сборка → деплой).*&nbsp;&nbsp;&nbsp;&nbsp;
* ***workflow** – правила запуска (например, только для main или MR).*
* ***cache** – ускоряет последующие запуски.*
* ***before_script** – команды, выполняемые перед основным скриптом.*
* ***artifacts** – сохраняет файлы между этапами (например, dist/).*
* ***only / except** – ограничивает запуск для определенных веток.*

Общее описание как работает CI

* Разработчик отправляет коммит в репозиторий, создаёт *merge request* через сайт, или ещё каким-либо образом явно или неявно запускает пайплайн,
* Из конфигурации выбираются все задачи, условия которых позволяют их запустить в данном контексте,
* Задачи организуются в соответствии со своими этапами,
* Этапы по очереди выполняются — т.е. параллельно выполняются все задачи этого этапа,
* Если этап завершается неудачей (т.е. завершается неудачей хотя бы одна из задач этапа) — пайплайн останавливается (почти всегда),
* Если все этапы завершены успешно, пайплайн считается успешно прошедшим.

**GitLab отправляет задачи (jobs) на раннеры (специальные серверы, которые выполняют код).**

**Runners** — это агенты, которые запускают наши задания. Эти агенты могут работать на физических машинах или виртуальных экземплярах. В `.gitlab-ci.yml` файле можно указать образ контейнера, который нужно использовать при запуске задания. Runner загружает образ, клонирует наш проект и запускает задание локально или в контейнере.
Раннеры могут быть: **Shared** (общие, предоставляемые GitLab) или **Specific** (ваши собственные серверы).

В GitLab CI/CD пайплайн (pipeline) — это автоматизированный процесс, который проходит код от коммита до деплоя. Он состоит из стадий (**stages**), а каждая стадия содержит задачи (**jobs**).

**Pipeline** - полный цикл выполнения CI/CD, который запускается при каждом изменении кода. Состоит из нескольких стадий (**stages**), которые выполняются последовательно или параллельно. Пайплайн проходит через все стадии (test → build → deploy). Если любая задача падает, пайплайн останавливается (если не настроено иначе).

**Stages** - Группы задач, которые выполняются последовательно.

Пример:

1. test → build → deploy

2. lint → test → security_scan → deploy

Следующая **stage** начнется, только когда все **jobs** из предыдущей завершатся успешно.

**Jobs** - Конкретное задание, которое выполняется внутри стадии.

После успешного прохождения всех этапов CI (тестов, анализа кода) идет процесс CD (Continuous Deployment) автоматический деплой кода на сервер.

CD (Continuous Deployment) работает в GitLab:

1. Автоматический запуск: CD-стадия выполняется только после успешного CI (тестов).

2. Ручное подтверждение (опционально):

3. Роллбек: Если деплой упал — GitLab покажет ошибку, и код не обновится.

В **GitLab CI/CD** существует несколько типов пайплайнов, предназначенных для разных сценариев и рабочих процессов

Типы пайплайнов в GitLab CI/CD:

1\. Базовый пайплайн

Стандартный CI/CD-процесс с последовательными стадиями (сборка, тестирование, деплой).

```
stages:
  - build
  - test
  - deploy

build_job:
  stage: build
  script: echo "Сборка..."

test_job:
  stage: test
  script: echo "Тестирование..."

deploy_job:
  stage: deploy
  script: echo "Деплой..."
```

---

2\. Веточные пайплайны

Разные пайплайны для разных веток (например, main и feature-веток).

```
deploy_prod:
  stage: deploy
  script: echo "Деплой в prod"
  only:
    - main

deploy_staging:
  stage: deploy
  script: echo "Деплой в staging"
  except:
    - main
```

---

3\. Пайплайны для Merge Request (MR)

Запускаются при создании или обновлении Merge Request.

```
code_review:
  stage: test
  script: echo "Проверка MR"
  only:
    - merge_requests
```

---

4\. Родительско-дочерние пайплайны

Для сложных проектов можно разделять пайплайны на родительские и дочерние.

```
include:
  - local: '/path/to/child-pipeline.yml'
```

---

5\. Мультипроектные пайплайны

Координация пайплайнов между несколькими проектами.

```
trigger_downstream:
  stage: deploy
  trigger:
    project: other-group/other-project
    strategy: depend
```

---

6\. Плановые пайплайны

Запускаются по расписанию (через UI или конфиг).

```
monthly_audit:
  stage: test
  script: ./run-audit
  only:
    - schedules
```

---

7\. Ручные пайплайны

Требуют ручного подтверждения для продолжения.

```
production_deploy:
  stage: deploy
  script: ./deploy-prod
  when: manual
```

---

8\. Пайплайны с Directed Acyclic Graph (DAG)

Задачи выполняются на основе зависимостей, а не строго по стадиям.

```
build_a:
  stage: build
  script: echo "A"

build_b:
  stage: build
  script: echo "B"

deploy:
  stage: deploy
  needs: ["build_a", "build_b"]
```

---

9\. Динамические пайплайны

Конфигурация генерируется на лету.

```
generate-config:
  stage: build
  script: generate-ci-config \> generated-config.yml
  artifacts:
    paths:
      - generated-config.yml

child-pipeline:
  stage: test
  trigger:
    include:
      - artifact: generated-config.yml
        job: generate-config
```

---

10\. Пайплайны с Feature Flags

Управление поведением пайплайна через флаги.

```
test_with_flag:
  script: echo "Экспериментальный тест"
  rules:
    - if: $FEATURE_FLAG_EXPERIMENTAL == "true"
```

---

В **GitLab** можно комбинировать их в рамках одного проекта.
